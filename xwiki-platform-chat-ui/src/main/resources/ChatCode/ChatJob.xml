<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>ChatCode</web>
  <name>ChatJob</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>Scheduler.WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1386165600000</creationDate>
  <date>1386606512000</date>
  <contentUpdateDate>1386168679000</contentUpdateDate>
  <version>1.1</version>
  <title>ChatJob</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.0</syntaxId>
  <hidden>true</hidden>
  <object>
    <class>
      <name>XWiki.SchedulerJobClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <contextDatabase>
        <disabled>0</disabled>
        <name>contextDatabase</name>
        <number>9</number>
        <prettyName>Job execution context database</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </contextDatabase>
      <contextLang>
        <disabled>0</disabled>
        <name>contextLang</name>
        <number>8</number>
        <prettyName>Job execution context lang</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </contextLang>
      <contextUser>
        <disabled>0</disabled>
        <name>contextUser</name>
        <number>7</number>
        <prettyName>Job execution context user</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </contextUser>
      <cron>
        <disabled>0</disabled>
        <name>cron</name>
        <number>5</number>
        <prettyName>Cron Expression</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </cron>
      <jobClass>
        <disabled>0</disabled>
        <name>jobClass</name>
        <number>3</number>
        <prettyName>Job Class</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </jobClass>
      <jobDescription>
        <disabled>0</disabled>
        <name>jobDescription</name>
        <number>2</number>
        <prettyName>Job Description</prettyName>
        <rows>10</rows>
        <size>45</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </jobDescription>
      <jobName>
        <disabled>0</disabled>
        <name>jobName</name>
        <number>1</number>
        <prettyName>Job Name</prettyName>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </jobName>
      <script>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>script</name>
        <number>6</number>
        <prettyName>Job Script</prettyName>
        <rows>10</rows>
        <size>60</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </script>
      <status>
        <disabled>0</disabled>
        <name>status</name>
        <number>4</number>
        <prettyName>Status</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </status>
    </class>
    <name>ChatCode.ChatJob</name>
    <number>0</number>
    <className>XWiki.SchedulerJobClass</className>
    <guid>0246a3de-f5ee-48a3-ac77-1503aeefe439</guid>
    <property>
      <contextDatabase>xwiki</contextDatabase>
    </property>
    <property>
      <contextLang>en</contextLang>
    </property>
    <property>
      <contextUser>XWiki.Admin</contextUser>
    </property>
    <property>
      <cron>0,30 * * * * ?</cron>
    </property>
    <property>
      <jobClass>com.xpn.xwiki.plugin.scheduler.GroovyJob</jobClass>
    </property>
    <property>
      <jobDescription>Multiuser Chat job removing disconnected users from group chats</jobDescription>
    </property>
    <property>
      <jobName>Chat Group Cleanup Job</jobName>
    </property>
    <property>
      <script>import org.apache.vysper.xmpp.extension.xep0124.BoshHandler;
import org.apache.vysper.xmpp.server.AbstractSessionContext;
import org.apache.vysper.xmpp.server.SessionState;
import org.apache.vysper.xmpp.addressing.EntityImpl;
import org.apache.vysper.xml.fragment.XMLElement;
import org.apache.vysper.xmpp.modules.extension.xep0045_muc.model.*;
import org.apache.vysper.xmpp.modules.extension.xep0045_muc.stanzas.Status;
import org.apache.vysper.xmpp.modules.extension.xep0045_muc.stanzas.Status.StatusCode;
import org.apache.vysper.xmpp.modules.extension.xep0045_muc.MUCStanzaBuilder;
import org.apache.vysper.xmpp.protocol.NamespaceURIs;
import org.apache.vysper.xmpp.stanza.PresenceStanzaType;
import org.apache.vysper.xmpp.delivery.failure.IgnoreFailureStrategy;
import org.apache.vysper.xmpp.delivery.failure.DeliveryException;
import org.apache.vysper.xmpp.modules.extension.xep0045_muc.stanzas.MucUserItem;

def sendExitRoomPresenceToExisting(exitingOccupant, existingOccupant, room, statusMessage, serverRuntimeContext) {
     
 def roomAndNewUserNick = new EntityImpl(room.getJID(), exitingOccupant.getNick());
 def inner = new ArrayList&lt;XMLElement&gt;();

 inner.add(new MucUserItem(null, null, existingOccupant.getAffiliation(), Role.None));

 // is this stanza to be sent to the exiting user himself?
 boolean ownStanza = existingOccupant.getJid().equals(exitingOccupant.getJid());

 if (ownStanza || statusMessage != null) {

            def status;
            if (ownStanza) {
                // send status to indicate that this is the users own presence
                status = new Status(StatusCode.OWN_PRESENCE, statusMessage);
            } else {
                status = new Status(statusMessage);
            }
            inner.add(status);
        }

 System.out.println("Informing user " + existingOccupant.getJid() + " of removal of " + exitingOccupant.getNick() + " of room " + room.getJID());

 def presenceToExisting = MUCStanzaBuilder.createPresenceStanza(roomAndNewUserNick,
                existingOccupant.getJid(), PresenceStanzaType.UNAVAILABLE, NamespaceURIs.XEP0045_MUC_USER, inner);

 try {
            serverRuntimeContext.getStanzaRelay().relay(existingOccupant.getJid(), presenceToExisting, new IgnoreFailureStrategy());
 } catch (DeliveryException e) {
            System.out.print("presence relaying failed ");
            e.printStackTrace();
 }
}


try {
System.out.println("Candy job starting")

def xmppServer = xcontext.getEngineContext().getAttribute("xmpp_server")
def muc = xmppServer.getServerRuntimeContext().getModule(org.apache.vysper.xmpp.modules.extension.xep0045_muc.MUCModule)
def conference = xwiki.getXWiki().getPrivateField(muc, "conference")
def srcontext = xmppServer.getServerRuntimeContext()

def endpoints = xwiki.getXWiki().getPrivateField(xmppServer, "endpoints")
def boshservlet = endpoints[1]
def boshhandler = (BoshHandler) xwiki.getXWiki().getPrivateField(boshservlet, "boshHandler")

def field = BoshHandler.class.getDeclaredField("sessions");  
field.setAccessible(true);  
def sessions = field.get(boshhandler);  
def goodIds = new ArrayList();

for (session in sessions.values()) {
 if (session.getStateHolder().getState()==SessionState.AUTHENTICATED) {
 def tstamp = xwiki.getXWiki().getPrivateField(session, "latestWriteTimestamp") 
 def iEntity = session.getInitiatingEntity();

 def field2 = AbstractSessionContext.class.getDeclaredField("attributeMap");  
 field2.setAccessible(true);  
 def map = field2.get(session)
 for (item in map.keySet()) {
   if (item.startsWith("DIRECTED_PRESENCE_MAP_")) {
     def id = item.replaceAll("DIRECTED_PRESENCE_MAP_", "")
     def fullJid = iEntity.toString() + "/" + id
     goodIds.add(fullJid)
   }
 }
 }
}

for (room in conference.getAllRooms()) {
 for (occ in room.getOccupants()) {
   if (!goodIds.contains(occ.toString())) {
      // let's remove user
      room.removeOccupant(occ.getJid());
      System.out.println("Removing occupant " + occ + " from room " + room);
      for (oocc in room.getOccupants()) {
         System.out.println("Announcing remove to occupant " + oocc + " from room " + room)
         sendExitRoomPresenceToExisting(occ, oocc, room, "unavailable", srcontext);
      }
   } else {
      System.out.println("Kept occupant " + occ + " for room " + room);
   }
 }
}

System.out.println("Candy job ending")
} catch (Throwable e) {
System.out.println("Candy job exception " + e.getMessage())
e.printStackTrace()
}</script>
    </property>
    <property>
      <status>Normal</status>
    </property>
  </object>
  <content>{{include document="XWiki.SchedulerJobSheet"/}}</content>
  <renderedcontent>&lt;p&gt;&lt;strong&gt;Job name:&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;Chat Group Cleanup Job&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Job description:&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;Multiuser Chat job removing disconnected users from group chats&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Job cron expression:&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;0,30 * * * * ?&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Job script:&lt;/strong&gt;&lt;/p&gt;&lt;div class="box"&gt;&lt;div class="code"&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.extension.xep0124.BoshHandler&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.server.AbstractSessionContext&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.server.SessionState&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.addressing.EntityImpl&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xml.fragment.XMLElement&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.modules.extension.xep0045_muc.model.*&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.modules.extension.xep0045_muc.stanzas.Status&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.modules.extension.xep0045_muc.stanzas.Status.StatusCode&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.modules.extension.xep0045_muc.MUCStanzaBuilder&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.protocol.NamespaceURIs&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.stanza.PresenceStanzaType&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.delivery.failure.IgnoreFailureStrategy&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.delivery.failure.DeliveryException&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;import&lt;/span&gt; &lt;span style="font-weight: bold; color: #0000FF; "&gt;org.apache.vysper.xmpp.modules.extension.xep0045_muc.stanzas.MucUserItem&lt;/span&gt;&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;def &lt;span style="color: #0000FF; "&gt;sendExitRoomPresenceToExisting&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;exitingOccupant&lt;span style="color: #666666; "&gt;,&lt;/span&gt; existingOccupant&lt;span style="color: #666666; "&gt;,&lt;/span&gt; room&lt;span style="color: #666666; "&gt;,&lt;/span&gt; statusMessage&lt;span style="color: #666666; "&gt;,&lt;/span&gt; serverRuntimeContext&lt;span style="color: #666666; "&gt;)&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;&amp;nbsp;def roomAndNewUserNick &lt;span style="color: #666666; "&gt;=&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;new&lt;/span&gt; EntityImpl&lt;span style="color: #666666; "&gt;(&lt;/span&gt;room&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJID&lt;/span&gt;&lt;span style="color: #666666; "&gt;(),&lt;/span&gt; exitingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getNick&lt;/span&gt;&lt;span style="color: #666666; "&gt;());&lt;/span&gt;&lt;br/&gt;&amp;nbsp;def inner &lt;span style="color: #666666; "&gt;=&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;new&lt;/span&gt; ArrayList&lt;span style="color: #666666; "&gt;&amp;lt;&lt;/span&gt;XMLElement&lt;span style="color: #666666; "&gt;&amp;gt;();&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&amp;nbsp;inner&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;add&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;new&lt;/span&gt; MucUserItem&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;null&lt;/span&gt;&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;null&lt;/span&gt;&lt;span style="color: #666666; "&gt;,&lt;/span&gt; existingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getAffiliation&lt;/span&gt;&lt;span style="color: #666666; "&gt;(),&lt;/span&gt; Role&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;None&lt;/span&gt;&lt;span style="color: #666666; "&gt;));&lt;/span&gt;&lt;br/&gt;&lt;br/&gt; &lt;span style="font-weight: italic; color: #408080; "&gt;// is this stanza to be sent to the exiting user himself?&lt;br/&gt;&lt;/span&gt; &lt;span style="color: #B00040; "&gt;boolean&lt;/span&gt; ownStanza &lt;span style="color: #666666; "&gt;=&lt;/span&gt; existingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJid&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;equals&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;exitingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJid&lt;/span&gt;&lt;span style="color: #666666; "&gt;());&lt;/span&gt;&lt;br/&gt;&lt;br/&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;if&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;ownStanza &lt;span style="color: #666666; "&gt;||&lt;/span&gt; statusMessage &lt;span style="color: #666666; "&gt;!=&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;null&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;def status&lt;span style="color: #666666; "&gt;;&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-weight: bold; color: #008000; "&gt;if&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;ownStanza&lt;span style="color: #666666; "&gt;)&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-weight: italic; color: #408080; "&gt;// send status to indicate that this is the users own presence&lt;br/&gt;&lt;/span&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;status &lt;span style="color: #666666; "&gt;=&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;new&lt;/span&gt; Status&lt;span style="color: #666666; "&gt;(&lt;/span&gt;StatusCode&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;OWN_PRESENCE&lt;/span&gt;&lt;span style="color: #666666; "&gt;,&lt;/span&gt; statusMessage&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="color: #666666; "&gt;}&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;else&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;status &lt;span style="color: #666666; "&gt;=&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;new&lt;/span&gt; Status&lt;span style="color: #666666; "&gt;(&lt;/span&gt;statusMessage&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;inner&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;add&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;status&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&amp;nbsp;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;println&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"Informing user "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; existingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJid&lt;/span&gt;&lt;span style="color: #666666; "&gt;()&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;" of removal of "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; exitingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getNick&lt;/span&gt;&lt;span style="color: #666666; "&gt;()&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;" of room "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; room&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJID&lt;/span&gt;&lt;span style="color: #666666; "&gt;());&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&amp;nbsp;def presenceToExisting &lt;span style="color: #666666; "&gt;=&lt;/span&gt; MUCStanzaBuilder&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;createPresenceStanza&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;roomAndNewUserNick&lt;span style="color: #666666; "&gt;,&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;existingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJid&lt;/span&gt;&lt;span style="color: #666666; "&gt;(),&lt;/span&gt; PresenceStanzaType&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;UNAVAILABLE&lt;/span&gt;&lt;span style="color: #666666; "&gt;,&lt;/span&gt; NamespaceURIs&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;XEP0045_MUC_USER&lt;/span&gt;&lt;span style="color: #666666; "&gt;,&lt;/span&gt; inner&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt;&lt;br/&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;try&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;serverRuntimeContext&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getStanzaRelay&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;relay&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;existingOccupant&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJid&lt;/span&gt;&lt;span style="color: #666666; "&gt;(),&lt;/span&gt; presenceToExisting&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;new&lt;/span&gt; IgnoreFailureStrategy&lt;span style="color: #666666; "&gt;());&lt;/span&gt;&lt;br/&gt; &lt;span style="color: #666666; "&gt;}&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;catch&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;DeliveryException e&lt;span style="color: #666666; "&gt;)&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;print&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"presence relaying failed "&lt;/span&gt;&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;e&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;printStackTrace&lt;/span&gt;&lt;span style="color: #666666; "&gt;();&lt;/span&gt;&lt;br/&gt; &lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;try&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;println&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"Candy job starting"&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;def xmppServer &lt;span style="color: #666666; "&gt;=&lt;/span&gt; xcontext&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getEngineContext&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getAttribute&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"xmpp_server"&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;def muc &lt;span style="color: #666666; "&gt;=&lt;/span&gt; xmppServer&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getServerRuntimeContext&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getModule&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;org&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;apache&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;vysper&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;xmpp&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;modules&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;extension&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;xep0045_muc&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;MUCModule&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;def conference &lt;span style="color: #666666; "&gt;=&lt;/span&gt; xwiki&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getXWiki&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getPrivateField&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;muc&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;"conference"&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;def srcontext &lt;span style="color: #666666; "&gt;=&lt;/span&gt; xmppServer&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getServerRuntimeContext&lt;/span&gt;&lt;span style="color: #666666; "&gt;()&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;def endpoints &lt;span style="color: #666666; "&gt;=&lt;/span&gt; xwiki&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getXWiki&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getPrivateField&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;xmppServer&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;"endpoints"&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;def boshservlet &lt;span style="color: #666666; "&gt;=&lt;/span&gt; endpoints&lt;span style="color: #666666; "&gt;[&lt;/span&gt;&lt;span style="color: #666666; "&gt;1&lt;/span&gt;&lt;span style="color: #666666; "&gt;]&lt;/span&gt;&lt;br/&gt;def boshhandler &lt;span style="color: #666666; "&gt;=&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;BoshHandler&lt;span style="color: #666666; "&gt;)&lt;/span&gt; xwiki&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getXWiki&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getPrivateField&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;boshservlet&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;"boshHandler"&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;def field &lt;span style="color: #666666; "&gt;=&lt;/span&gt; BoshHandler&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;class&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getDeclaredField&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"sessions"&lt;/span&gt;&lt;span style="color: #666666; "&gt;);&lt;/span&gt; &amp;nbsp;&lt;br/&gt;field&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;setAccessible&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;true&lt;/span&gt;&lt;span style="color: #666666; "&gt;);&lt;/span&gt; &amp;nbsp;&lt;br/&gt;def sessions &lt;span style="color: #666666; "&gt;=&lt;/span&gt; field&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;get&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;boshhandler&lt;span style="color: #666666; "&gt;);&lt;/span&gt; &amp;nbsp;&lt;br/&gt;def goodIds &lt;span style="color: #666666; "&gt;=&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;new&lt;/span&gt; ArrayList&lt;span style="color: #666666; "&gt;();&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;for&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;session in sessions&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;values&lt;/span&gt;&lt;span style="color: #666666; "&gt;())&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;if&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;session&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getStateHolder&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getState&lt;/span&gt;&lt;span style="color: #666666; "&gt;()==&lt;/span&gt;SessionState&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;AUTHENTICATED&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&amp;nbsp;def tstamp &lt;span style="color: #666666; "&gt;=&lt;/span&gt; xwiki&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getXWiki&lt;/span&gt;&lt;span style="color: #666666; "&gt;().&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getPrivateField&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;session&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;"latestWriteTimestamp"&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt; &lt;br/&gt;&amp;nbsp;def iEntity &lt;span style="color: #666666; "&gt;=&lt;/span&gt; session&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getInitiatingEntity&lt;/span&gt;&lt;span style="color: #666666; "&gt;();&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&amp;nbsp;def field2 &lt;span style="color: #666666; "&gt;=&lt;/span&gt; AbstractSessionContext&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;class&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getDeclaredField&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"attributeMap"&lt;/span&gt;&lt;span style="color: #666666; "&gt;);&lt;/span&gt; &amp;nbsp;&lt;br/&gt;&amp;nbsp;field2&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;setAccessible&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;true&lt;/span&gt;&lt;span style="color: #666666; "&gt;);&lt;/span&gt; &amp;nbsp;&lt;br/&gt;&amp;nbsp;def map &lt;span style="color: #666666; "&gt;=&lt;/span&gt; field2&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;get&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;session&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;for&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;item in map&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;keySet&lt;/span&gt;&lt;span style="color: #666666; "&gt;())&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&lt;span style="font-weight: bold; color: #008000; "&gt;if&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;item&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;startsWith&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"DIRECTED_PRESENCE_MAP_"&lt;/span&gt;&lt;span style="color: #666666; "&gt;))&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;def id &lt;span style="color: #666666; "&gt;=&lt;/span&gt; item&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;replaceAll&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"DIRECTED_PRESENCE_MAP_"&lt;/span&gt;&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;""&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;def fullJid &lt;span style="color: #666666; "&gt;=&lt;/span&gt; iEntity&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;toString&lt;/span&gt;&lt;span style="color: #666666; "&gt;()&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;"/"&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; id&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;goodIds&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;add&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;fullJid&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt; &lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt; &lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;&lt;span style="font-weight: bold; color: #008000; "&gt;for&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;room in conference&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getAllRooms&lt;/span&gt;&lt;span style="color: #666666; "&gt;())&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;for&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;occ in room&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getOccupants&lt;/span&gt;&lt;span style="color: #666666; "&gt;())&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&lt;span style="font-weight: bold; color: #008000; "&gt;if&lt;/span&gt; &lt;span style="color: #666666; "&gt;(!&lt;/span&gt;goodIds&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;contains&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;occ&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;toString&lt;/span&gt;&lt;span style="color: #666666; "&gt;()))&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-weight: italic; color: #408080; "&gt;// let's remove user&lt;br/&gt;&lt;/span&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;room&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;removeOccupant&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;occ&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getJid&lt;/span&gt;&lt;span style="color: #666666; "&gt;());&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;println&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"Removing occupant "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; occ &lt;span style="color: #666666; "&gt;+&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;" from room "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; room&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="font-weight: bold; color: #008000; "&gt;for&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;oocc in room&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getOccupants&lt;/span&gt;&lt;span style="color: #666666; "&gt;())&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;println&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"Announcing remove to occupant "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; oocc &lt;span style="color: #666666; "&gt;+&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;" from room "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; room&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;sendExitRoomPresenceToExisting&lt;span style="color: #666666; "&gt;(&lt;/span&gt;occ&lt;span style="color: #666666; "&gt;,&lt;/span&gt; oocc&lt;span style="color: #666666; "&gt;,&lt;/span&gt; room&lt;span style="color: #666666; "&gt;,&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;"unavailable"&lt;/span&gt;&lt;span style="color: #666666; "&gt;,&lt;/span&gt; srcontext&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&lt;span style="color: #666666; "&gt;}&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;else&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;println&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"Kept occupant "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; occ &lt;span style="color: #666666; "&gt;+&lt;/span&gt; &lt;span style="color: #BA2121; "&gt;" for room "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; room&lt;span style="color: #666666; "&gt;);&lt;/span&gt;&lt;br/&gt; &amp;nbsp;&amp;nbsp;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt; &lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;println&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"Candy job ending"&lt;/span&gt;&lt;span style="color: #666666; "&gt;)&lt;/span&gt;&lt;br/&gt;&lt;span style="color: #666666; "&gt;}&lt;/span&gt; &lt;span style="font-weight: bold; color: #008000; "&gt;catch&lt;/span&gt; &lt;span style="color: #666666; "&gt;(&lt;/span&gt;Throwable e&lt;span style="color: #666666; "&gt;)&lt;/span&gt; &lt;span style="color: #666666; "&gt;&amp;#123;&lt;/span&gt;&lt;br/&gt;System&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;out&lt;/span&gt;&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;println&lt;/span&gt;&lt;span style="color: #666666; "&gt;(&lt;/span&gt;&lt;span style="color: #BA2121; "&gt;"Candy job exception "&lt;/span&gt; &lt;span style="color: #666666; "&gt;+&lt;/span&gt; e&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;getMessage&lt;/span&gt;&lt;span style="color: #666666; "&gt;())&lt;/span&gt;&lt;br/&gt;e&lt;span style="color: #666666; "&gt;.&lt;/span&gt;&lt;span style="color: #7D9029; "&gt;printStackTrace&lt;/span&gt;&lt;span style="color: #666666; "&gt;()&lt;/span&gt;&lt;br/&gt;&lt;span style="color: #666666; "&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;p&gt;&lt;span class="wikilink"&gt;&lt;a href="/xwiki/bin/view/Scheduler/WebHome"&gt;Back to the job list&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</renderedcontent>
</xwikidoc>
